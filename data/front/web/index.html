<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Web denoiser demo</title>
</head>

<body>
  <h1>Web denoiser</h1>

  <div id="app">
    <waveform ref="source"></waveform>
    <waveform ref="result"></waveform>
  </div>


  <audio controls=controls>
    <source src="/public/speech1.wav">
  </audio>

  <canvas id="canvas" width="450" height="275">
    Canvas not supported
  </canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/peaks.js/0.9.8/peaks.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.13/vue.js"></script>
  <script src="/vendor/waveform-data.js"></script>
  <script type="module" src="/component.js"></script>
  <script type="module" src="/app.js"></script>
  <script>
    var waveform;
    var waveformResponse;
    const xhr = new XMLHttpRequest();
    // .dat file generated by audiowaveform program 
    xhr.responseType = "arraybuffer";
    xhr.open("GET", "/public/speech1.wav.dat");

    xhr.addEventListener("load", progressEvent => {
      waveformResponse = progressEvent.target;
      waveform = WaveformData.create(waveformResponse.response);

      console.log("waveform loaded:" + waveform.duration);

      drawWaveform();
    });

    xhr.send();

    const interpolateHeight = (total_height) => {
      const amplitude = 256;
      return (size) => total_height - ((size + 128) * total_height) / amplitude;
    };

    function drawWaveform() {
      var canvas = document.getElementById('canvas'),
        context = canvas.getContext('2d'),
        repeatRadio = document.getElementById('repeatRadio'),
        noRepeatRadio = document.getElementById('noRepeatRadio'),
        repeatXRadio = document.getElementById('repeatXRadio'),
        repeatYRadio = document.getElementById('repeatYRadio'),
        image = new Image();

      console.log(canvas)

      var canvas = document.getElementById('canvas');

      const y = interpolateHeight(canvas.height);
      const ctx = canvas.getContext("2d");
      ctx.beginPath();

      // from 0 to 100
      waveform.min.forEach((val, x) => ctx.lineTo(x + 0.5, y(val) + 0.5));

      // then looping back from 100 to 0
      waveform.max.reverse().forEach((val, x) => {
        ctx.lineTo((waveform.offset_length - x) + 0.5, y(val) + 0.5);
      });

      ctx.closePath();
      ctx.stroke();
    }



  </script>
</body>

</html>